<!DOCTYPE html>
<html lang="en-us">
    <head>
		<title>The Perfect Chocolate Chip Cookie</title>
		<meta charset="utf-8">
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/webfont/1.6.26/webfont.js"></script>
		<link href="https://fonts.googleapis.com/css?family=Fascinate|Open+Sans" rel="stylesheet">
		<script src="/jscript/d3v4+jetpack.js"></script>
		<script src="/jscript/graph-scroll.js"></script>
		<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
		<script src="/jscript/analyticstracking.js"></script>
		<link rel="stylesheet" href="/css/reset.css">
		<link rel="stylesheet" href="cookie.css">
   </head>
	<body>
		<div id="header">
			<h1>The Perfect Chocolate Chip Cookie</h1>
		</div>
		<div id="contentColumn">
			<p id="intro">The quest to find the definitive version of America's favorite snack from every recipe the web has to offer.</p>
			<div id="origRecipe">
				<div class="inset">
					<h2>The Toll House Cookie</h2>
					<ul>
						<li>1 1/2 cups of shortening</li>
						<li>1 1/8 cups of sugar</li>
						<li>1 1/8 cups of brown sugar</li>
						<li>3 eggs</li>
						<li>1 1/2 teaspoon of salt</li>
						<li>3 1/8 cups of flour</li>
						<li>1 1/2 teaspoon of hot water</li>
						<li>1 1/2 teaspoon of baking soda</li>
						<li>1 1/2 teaspoon of vanilla</li>
						<li>Chocolate chips (and walnuts)</li>
					</ul>
					<p>Bake at 350 degrees for 12-13 minutes</p>
				</div>
				<p class="caption">Is the original recipe still the best?</p>
			</div>
			<p>The Chocolate Chip Cookie is a classic. The King of Cookies. A timeless masterpiece and the favourite of America’s foremost cookie connoisseur: Cookie Monster.</p>
			<p>It was invented in 1938 by Ruth Graves Wakefield and named the Toll House Cookie after the inn she owned. The original recipe contains just 10 ingredients of which fat, sugar, flour, eggs and, of course, chocolate chips are the staples.</p>
			<p>Pretty simple. However in the intervening 79 years the chefs of the world have not been satisfied to leave a culinary classic alone. Infact so many have tried to modify and improve the humble CCC that we are now in the regrettable situation where a search on <a href="http://www.yummly.com" target="yummly">yummly.com</a> for “Chocolate Chip Cookie” returns an astonishing 29,921 recipes.</p>
			<p>For the home cookie maker it leaves an obvious but impossible to answer question: Which of these recipes is the best?</p>
			<p><a href="http://www.yummly.uk/#recipe/Perfect-Chocolate-Chip-Cookies-1688970" target="yummly">“Perfect Chocolate Chip Cookies”</a> from The Guardian website is the most popular with over 3000 “Yums” but has a below-perfect average rating of 4.1/5 from 7 reviews.</p>
			<p><a href="http://www.yummly.uk/#recipe/Chocolate-Chip-Cookies-1759719" target="yummly">"Chocolate Chip Cookies”</a> from Manu’s Menu has a perfect rating of 5/5 but from only 3 reviews and boasts a paltry 230 “Yums”.</p>
			<p>And what about the rest? Has anyone ever scrolled all the way down to recipe 29,921 and tried it? Perhaps it is the greatest recipe ever formulated. Perhaps it renders cookies of such breathtaking deliciousness that after one bite Otis Spunkmeyer would hang up his floppy white hat and denounce his life’s work as a meaningless sham. We don’t know. Even trying to scroll that far would wear the tip of your finger to the bone. How can we ever be sure which is the definitive Chocolate Chip Cookie recipe?</p>
			<p>We can’t. But with such a large dataset we can at least submit ourselves to the wisdom of the crowd. We will gratefully utilise these millions of hours of kitchen experimentation by thousands of nameless internet chefs. We will take all these recipes, mix them together, stir vigorously and bake in the pre-warmed oven of data analysis until we have the scientifically(-ish) proven <strong>greatest ever chocolate chip cookie recipe</strong>. The pinnacle of milk-dunking perfection.</p>
			<p>Or failing that the mathematically established “most average”.</p>
			<img src="cookie-break.png" class="break" />
			<p>Before we dive into this ocean of recipes are we sure that all 30,000 really do produce something Ruth Wakefield would recognise as a Toll House Cookie? Or are some merely imposters trading off the good name of the Chocolate Chip Cookie? And how are we going to seperate the genuine article from the less-than-blue-chip cookie?</p>
			<p>Its time to introduce a a couple of ground rules:</p>
			<div id="filterContainer">
				<div id="filterChart">
					<div class="inset">
						<h2>Cooking Techniques</h2>
						<svg id="filterSVG" width="560" height="410"></svg>
					</div>
				</div>
				<div id='filterSections'>
					<div>
						<p><strong>1. The cookie must be baked</strong></p>
						<p>Yummly allows us to filter on "cooking technique" and remarkably when we choose "baked" a huge 12,000 recipes are deselected. That is an awful lot of cookies that are browned, microwaved, boiled or even braised. But the original recipe says "bake" and that is good enough for us. There won't be any marinating involved with our cookie.</p>
					</div>
					<div>
						<p><strong>2. The cookie must contain chocolate chips</strong></p>
						<p>These are tempestuous times but if there is one thing I am still absolutely certain of it is this: the ultimate Chocolate Chip Cookie contains chocolate chips. Not M&Ms. Not broken Oreos, Not Toblerone, Mars, Hershey's Kisses, Andes Cr&egrave;me de Menthe Thins or any of the other imposters some 2,856 recipes would substitute. Equally we won't be making a chocolate chip cookie that doesn't contain any chocolate. These recipes have embarrassed themselves and we won't be wasting any more time on them.</p>
					</div>
					<div>&nbsp;</div>
				</div>
			</div>
			<p>Exploring the Yummly filters reveals that 2,834 recipes involve microwaving, 1,228 boiling, 128 broiling and one even calls for brining. I don't want to live in a world where the ultimate CCC involves brining so we won’t be using any of these techniques and will stick to traditional baking. This immediately reduces our recipe count to a, still formidable, 17,153.</p>
			<p></p>

			<p>We can also filter on whether a recipe contains a certain ingredient. Later we will be discussing whether a CCC should be made with shortening or butter, with plain or self raising flour, with brown or white sugar but there is one ingredient that is essential in a CCC and that is chocolate chips. A quick scan through our recipes reveals various other chocolate imposters have been substituted (M&Ms, Oreos, Toblerone, Mars, Hershey's Kisses, even Andes Cr&egrave;me de Menthe Thins) but if there is one thing I am absolutely certain of in these tempestuous times it is this: the ultimate Chocolate Chip Cookie contains chocolate chips. Our total recipe count is now 13,272.</p>
			<p>(Interesting filter found fact: We aren’t going to cater for people with food intolerances but its reassuring to know that even if you are allergic to dairy, egg, gluten, peanuts, seafood, sesame, soy, sulfites, tree nuts AND wheat there are still 44 recipes you can use.)</p>
			<img src="cookie-break.png" class="break" />
			<p>We've identified that some chefs are going unacceptably off-piste by leaving chocolate chips out of their chocolate chip cookie recipes but are there also unsanctioned ingredients that they have been sneaking in? I've analysed the ingredients of all the remaining recipes and there are some shocking inclusions.</p>


			<p>Filler</p>
			<p>Filler</p>

			<div id="container">
				<div id="graph">
					<div class="inset" id="ingredientsGraph">
						<h2>Ingredients</h2>
					</div>
				</div>
				<div id='sections'>
					<div>
						<h3>Connect text and graphics</h3>
						takes a selection of explanatory text sections and dispatches <span class='mono'>active</span> events as different sections are scrolled into to view. These active events are used to update a graph's state.
						<pre>
						d3.graphScroll()
						.sections(d3.selectAll('#sections > div'))
						.on('active', function(i){
						console.log(i + 'th section active') })
						</pre>
					</div>
					<div>
						<h3>Highlight active text</h3>
						The top most text section scrolled into view is classed <span class='mono'>graph-scroll-active</span>. This makes it easy to highlight the active section with css: 
						<pre>
						#sections > div{
						opacity: .3
						} 

						#sections div.graph-scroll-active{
						opacity: 1;
						}
						</pre>
					</div>
					<div>
						<h3>Headers and footers</h3>
						To support headers and intro images/text, the explanatory text and graphic are wrapped with a container element:    
						<pre>
						&lt;h1&gt;Page Title&lt;/div&gt;
						&lt;div id='container'&gt;
						&lt;div id='graph'&gt;&lt;/div&gt;
						&lt;div id='sections'&gt;
						&lt;div&gt;Section 0&lt;/div&gt;
						&lt;div&gt;Section 1&lt;/div&gt;
						&lt;div&gt;Section 2&lt;/div&gt;
						&lt;/div&gt;
						&lt;/div&gt;
						&lt;h1&gt;Footer&lt;/h1&gt;
						</pre>

						and passed to <span class='mono'>graphScroll</span>

						<pre>
						d3.graphScroll()
						.graph(d3.select('#graph'))
						.container(d3.select('#container'))
						<pre>
					</div>
					<div>
						<h3>Sticky graph</h3>
						When the graph starts to scroll out of view, the container is classed with <span class='mono'>graph-scroll-fixed</span>. With a little bit of css, the graph element snaps to the top of the page while the text scrolls by. 
						<pre>
						#container{
						position: relative;
						}

						#sections{
						width: 340px;
						}

						#graph{
						width: 500px;
						margin-left: 380px;
						position: absolute;
						top: 0px;
						}

						.graph-scroll-fixed #graph{
						position: fixed;
						}
						</pre>
					</div>
				</div>
			</div>





			<p>Filler</p>
			<p>Filler</p>
			<div id="techniqueTable">
				<div class="inset">
					<h2>Cooking Techniques</h2>
					<table>
						<tr><th>Cooking Technique</th><th>No. of recipes</th></tr>
						<tr><td>Baking</td><td>17153</td></tr>
						<tr><td>Blending</td><td>556</td></tr>
						<tr><td>Boiling</td><td>1228</td></tr>
						<tr><td>Braising</td><td>1</td></tr>
						<tr><td>Brining</td><td>1</td></tr>
						<tr><td>Broiling</td><td>128</td></tr>
						<tr><td>Browning</td><td>7464</td></tr>
						<tr><td>Drying</td><td>74</td></tr>
						<tr><td>Frosting</td><td>843</td></tr>
						<tr><td>Frying</td><td>0</td></tr>
						<tr><td>Glazing</td><td>227</td></tr>
						<tr><td>Grilling</td><td>33</td></tr>
						<tr><td>Marinating</td><td>2</td></tr>
						<tr><td>Microwaving</td><td>2834</td></tr>
						<tr><td>Poaching</td><td>2</td></tr>
						<tr><td>Pressure Cooking</td><td>4</td></tr>
						<tr><td>Roasting</td><td>54</td></tr>
						<tr><td>Sauteeing</td><td>73</td></tr>
						<tr><td>Slow Cooking</td><td>60</td></tr>
						<tr><td>Steaming</td><td>12</td></tr>
						<tr><td>Stir Frying</td><td>0</td></tr>
						<tr><td>Stuffing</td><td>0</td></tr>
					</table>
				</div>
				<p class="caption">Are some chefs really marinating their cookies?</p>
			</div>

			<p>OK, now we have thinned the field a little lets find out which way this cookie crumbles.</p>
			<p>[Editorial note: For now I have scraped 913 recipes from the Yummly site but ideally I would use their API to access the entire database]</p>
			<p>Also worryingly there are 51 recipes classed as “More Spicy” and 190 classed as “More Sour”. These don’t sound like ideal characteristics for a definitive CCC so we’ll also filter these out. </p>
		</div>
		<script>
			var scroll = d3.graphScroll()
				.container(d3.select('#container'))
				.graph(d3.select('#graph'))
				.sections(d3.selectAll('#sections > div'))
				.on('active', function(i){
					console.log(i + 'th section active');
					if(i%2==1){
						updateData('data/unusualIngredients.json');
					}else{
						updateData('data/topIngredients.json');
					}
				})
			;

			var filterScroll = d3.graphScroll()
				.container(d3.select('#filterContainer'))
				.graph(d3.select('#filterChart'))
				.sections(d3.selectAll('#filterSections > div'))
				.on('active', function(i){
					updateFilterChart(i);
				})
			;


			var svg = d3.select("#ingredientsGraph").append("svg").attr("width", 800).attr("height", 600),
				margin = {top: 50, right: 20, bottom: 0, left: 180},
    			width = +svg.attr("width") - margin.left - margin.right,
    			height = +svg.attr("height") - margin.top - margin.bottom
    		;
    		
    		var x = d3.scaleLinear().range([0, width]);
			var y = d3.scaleBand().range([height, 0]);
			
			var xAxis = d3.axisTop(x).ticks(10).tickFormat(function(d) { return d; }).tickSizeInner([-height]);
			var yAxis = d3.axisLeft(y);

			var g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");


			function drawChart(dataset){
				d3.json(dataset, function(error, data) {
					if (error) throw error;
					data.sort(function(a, b) { return a.number - b.number; });

					x.domain([0, d3.max(data, function(d) { return d.number; })]);
					y.domain(data.map(function(d) { return d.ingredient; })).padding(0.4);

					g.append("g")
						.attr("class", "x axis")
						.attr("transform", "translate(0,0)")
						.call(xAxis)
					;
					g.append("g")
						.attr("class", "y axis")
						.call(yAxis)
					;
					var bar = g.selectAll(".bar")
						.data(data, function(d) { return d.ingredient; })
						.enter().append("rect")
						.attr("class", "bar")
						.attr("x", 0)
						.attr("height", y.bandwidth())
						.attr("y", function(d) { return y(d.ingredient); })
						.attr("width", function(d) { return x(d.number); })
					;
				});  
			}

			function updateData(dataset){
				d3.json(dataset, function(error, data) {
					data.sort(function(a, b) { return a.number - b.number; });

					x.domain([0, d3.max(data, function(d) { return d.number; })]);
					y.domain(data.map(function(d) { return d.ingredient; })).padding(0.4);

					var svg = d3.select("body").transition();

					svg.select(".x.axis")
						.duration(750)
						.call(xAxis)
					;

					svg.select(".y.axis")
						.duration(750)
						.call(yAxis)
					;
					var bar = g.selectAll(".bar")
						.data(data, function(d) { return d.ingredient; })
					;
					bar
						.enter()
						.append("rect")
						.attr("class", "bar")
						.attr("x", 0)
						.attr("height", y.bandwidth())
						.attr("y", function(d) { return y(d.ingredient); })
						.attr("width", function(d) { return x(d.number); })
					;
					bar.exit().remove();
					
				});
			}

   			drawChart("data/topIngredients.json");

			var stack = d3.stack();

			var filterWidth = 560;
			var filterHeight = 410;

			function drawFilterChart(){
				runningTotal = 0;
				scale = 1/90;
				runningTotal2 = 0;
				scale2 = 1/45;
				count = 0;


				d3.json("data/technique.json", function(data) {
					data.techniques.forEach(function(d) {
						d.offset = runningTotal;
						d.barheight = Math.max(2,Math.round(d.number*scale));
						runningTotal += d.barheight;
						runningTotal2 = 0;
						runningTotal3 = 0;
						d.chocolate.forEach(function(d) {
							d.count = count;
							d.offset = runningTotal2;
							d.offset2 = runningTotal3;
							d.barheight = Math.max(2,Math.round(d.number*scale));
							d.barheight2 = Math.max(2,Math.round(d.number*scale2));
							runningTotal2 += d.barheight;
							runningTotal3 += d.barheight2;
						});
						count++;
					});
					filterSVG = d3.select("#filterSVG");
					techniques = filterSVG
						.selectAll("g")
						.data(data.techniques)
						.enter()
						.append("g")
						.attr("transform", function(d,i) { 
							return "translate(50,"+ (405 - (d.offset + 2*i)) +")";
						})
						.attr("class","filterGroup")
					;
					techniques
						.append("text")
						.attr("class", function(d,i) {
							if(i==0){
								return "filterLabel big";
							} else {
								return "filterLabel";
							}
						})
						.attr("transform", function(d,i) { 
							if(i==0){
								return "translate(300,"+ (d.offset - 13*i) +")";
							}else{
								return "translate(300,"+ (d.offset - (13*i + 4)) +")";
							}
						})
						.text(function(d,i) { 
							return d.name + " (" + d.number + ")";
						})
					;
					techniques
						.append("line")
						.attr("class", "filterLine")
						.attr("x1", 82)
						.attr("y1", function(d,i) { 
							return -d.barheight/2;
						})
						.attr("x2", 298)
						.attr("y2", function(d,i) { 
							return (d.offset - (13*i + 4));
						})
					;
					techniques
						.selectAll("rect")
						.data(function(d) {
							console.log(d); 
							return d.chocolate; 
						})
						.enter()
						.append("rect")
						.attr("class", "filterRect")
						.attr("width", 80)
						.attr("height", function(d) { 
							return d.barheight; 
						})
						.attr("x", 0)
						.attr("y", function(d) { 
							return -d.offset-d.barheight;
						})
					;
					var chocolate = techniques
						.append("g")
					;
					chocolate
						.selectAll("line")
						.data(function(d) {
							return d.chocolate; 
						})
						.enter()
						.append("line")
						.attr("class", "filterLine2")
						.attr("opacity", 0)
						.attr("x1", 82)
						.attr("y1", function(d,i) { 
							return 0-(d.offset2+d.barheight2/2+2*i);
						})
						.attr("x2", 298)
						.attr("y2", function(d,i) { 
							return 0-(15*i + 4);
						})
					;
					chocolate
						.selectAll("text")
						.data(function(d) {
							return d.chocolate; 
						})
						.enter()
						.append("text")
						.attr("class", function(d,i) {
							if(i==0){
								return "filterLabel2 big";
							} else {
								return "filterLabel2";
							}
						})
						.attr("opacity", 0)
						.attr("transform", function(d,i) { 
							if(i==0){
								return "translate(300,0)";
							}else{
								return "translate(300,"+ (-4-(15*i)) +")";
							}
						})
						.text(function(d,i) { 
							return d.type + " (" + d.number + ")";
						})
					;
				});  
			}

			function updateFilterChart(i){
				var transFilter = d3.select("#filterContainer").transition();
				filterSVG = d3.select("#filterSVG");
				if(i==1){
					transFilter
						.duration(750)
						.selectAll(".filterGroup")
						.attr("transform", function(d,i) { 
							return "translate(50,"+ (400 - (d.offset + 400*i)) +")";
						})
					;
					transFilter
						.delay(750)
						.selectAll("h2")
						.text("Chocolate Content")
					;
					transFilter
						.delay(750)
						.duration(750)
						.selectAll(".filterRect")
						.attr("height", function(d) { 
							return d.barheight2; 
						})
						.attr("y", function(d,i) { 
							return -(d.offset2+d.barheight2+i*2);
						})
					;
					transFilter
						.delay(750)
						.selectAll(".filterLine")
						.attr("opacity", 0)
					;
					transFilter
						.delay(750)
						.selectAll(".filterLabel")
						.attr("opacity", 0)
					;
					transFilter
						.delay(1500)
						.selectAll(".filterLine2")
						.attr("opacity", 1)
					;
					transFilter
						.delay(1500)
						.selectAll(".filterLabel2")
						.attr("opacity", 1)
					;

				}else if(i==0){
					transFilter
						.delay(1500)
						.duration(750)
						.selectAll(".filterGroup")
						.attr("transform", function(d,i) { 
							return "translate(50,"+ (405 - (d.offset + 2*i)) +")";
						})
					;
					transFilter
						.delay(750)
						.selectAll("h2")
						.text("Cooking Techniques")
					;
					transFilter
						.duration(750)
						.selectAll(".filterRect")
						.attr("height", function(d) { 
							return d.barheight; 
						})
						.attr("y", function(d,i) { 
							return -(d.offset+d.barheight);
						})
					;
					transFilter
						.delay(750)
						.selectAll(".filterLine")
						.attr("opacity", 1)
					;
					transFilter
						.delay(750)
						.selectAll(".filterLabel")
						.attr("opacity", 1)
					;
					transFilter
						.selectAll(".filterLine2")
						.attr("opacity", 0)
					;
					transFilter
						.selectAll(".filterLabel2")
						.attr("opacity", 0)
					;
				}
			}


   			drawFilterChart();



		</script>
	</body>
</html>

